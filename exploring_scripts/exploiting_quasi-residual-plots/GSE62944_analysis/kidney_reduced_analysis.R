labels=read.csv("sample_datasets/GSE62944/kidney_subset/labels.csv")
datar=read.csv("sample_datasets/GSE62944/kidney_subset/tpm_expression.csv")
covariates=read.csv("sample_datasets/GSE62944/kidney_subset/covariates.csv")

#SUBSAPLING
labels=labels[,2]
norm_idx <- which(labels == "NORM")
kirc_idx <- which(labels == "KIRC")
kirp_idx <- which(labels == "KIRP")

# Sample indices from each category
norm_sample <- sample(norm_idx, 100, replace = FALSE)
kirc_sample <- sample(kirc_idx, 100, replace = FALSE)
kirp_sample <- sample(kirp_idx, 100, replace = FALSE)

# Combine the samples into a single vector of indices
sample_idx <- c(norm_sample, kirc_sample, kirp_sample)

data=list() #pamr wants list
data$y=as.matrix(labels)
data$y=data$y[sample_idx,]
datar=datar[,2:ncol(datar)]
data$x=as.matrix(datar[,sample_idx])
str(data$x)
str(data$y)

#FITTING

library(pamr)

pamr=pamr.train(data)
thres=pamr.adaptthresh(pamr)
pamr=pamr.train(data, threshold.scale = thres)
pamr
pamrcv=pamr.cv(pamr, data)
pamrcv

source("feature_code/R/VCR_pamr.R")

#VISUAL TOOLS

library(classmap)
vcrpamr=vcr.pamr.train(data,pamr, pamrfitcv=pamrcv, threshold=16)



silplot(vcrpamr)
classmap(vcrpamr, whichclass = 3)

gender=unlist(covariates[45,2:ncol(covariates)], use.names = FALSE)
gender_coded <- ifelse(gender == "MALE", 0, 1)
average_expression_level=colSums(data$x)

age=as.numeric(unlist(covariates[2,2:ncol(covariates)], use.names = FALSE))

carbon_test=as.numeric(unlist(covariates[22,2:ncol(covariates)], use.names = FALSE))
#how are NAs treated in qresplot?? #test revealed that it ignores them all good!


?qresplot
qres=qresplot(vcrpamr$PAC, average_expression_level, xlab = "Age (years)", opacity = 0.5,
              main = "quasi residual plot for male passengers", plotLoess = TRUE)

#testing missing values
nona=which(!is.na(carbon_test))
vcrpamr$PAC[nona]

qres=qresplot(vcrpamr$PAC[400:800], carbon_test[400:800], xlab = "Age (years)", opacity = 0.5,
              main = "quasi residual plot for male passengers", plotLoess = TRUE)


#disturbance genes

coeff=rep(NA,ncol(t(data$x)))

for (i in 1:length(coeff)) {
  lm=lm(vcrpamr$PAC~t(data$x)[,i])
  coeff[i]=lm$coefficients[2]
}

sorted_indices <- order(coeff, decreasing = TRUE)
sorted_indices[1:10]
which.max(coeff)
lm(vcrpamr$PAC~t(khanc$x)[,424])

qres=qresplot(vcrpamr$PAC, t(data$x)[,], xlab = "Age (years)", opacity = 0.5,
              main = "quasi residual plot for male passengers", plotLoess = TRUE)
