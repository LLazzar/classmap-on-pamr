labels=read.csv("sample_datasets/GSE62944/lung_subset/labels.csv")
datar=read.csv("sample_datasets/GSE62944/lung_subset/tpm_expression.csv")
covariates=read.csv("sample_datasets/GSE62944/lung_subset/covariates.csv")

sc=read.table("sample_datasets/GSE62944/GSE60052_79tumor.7normal.normalized.log2.data.Rda.tsv")
str(sc)
sc[1,]
labels_sc <- rep("SC", 86)
labels_sc[c(35, 39, 42, 46, 80:82)] <- "NORM"

common_strings <- intersect(sc[,1], datar[,1])
n_common_strings <- length(common_strings)
n_common_strings

datar <- datar[datar$X %in% common_strings, ]  #subset to common genes to see if classification still ok
sc=sc[sc$V1 %in% common_strings, ]
dim(sc)
sc=as.matrix(sc[,-1])
str(sc)
nrow=nrow(sc)
nrow
sc=as.numeric(sc)
sc<- matrix(sc, nrow = nrow, byrow = TRUE)
str(sc)
datar=cbind(datar,sc)
dim(datar)

labels=labels[,2]
labels=c(labels,labels_sc)
length(labels)

data=list() #pamr wants list
data$y=as.matrix(labels)
data$x=as.matrix(datar[,2:ncol(datar)])
str(data$x)
str(data$y)

#FITTING

library(pamr)

pamr=pamr.train(data)
thres=pamr.adaptthresh(pamr)
pamr=pamr.train(data, threshold.scale = thres)
pamr
pamrcv=pamr.cv(pamr, data)
pamrcv

source("feature_code/R/VCR_pamr.R")

#VISUAL TOOLS

library(classmap)
vcrpamr=vcr.pamr.train(data,pamr, pamrfitcv=pamrcv, threshold=20.8)



silplot(vcrpamr)
classmap(vcrpamr, whichclass = 1)


gender=unlist(covariates[40,2:ncol(covariates)], use.names = FALSE)
gender_coded <- ifelse(gender == "MALE", 0, 1)
average_expression_level=colSums(data$x)

age=as.numeric(unlist(covariates[2,2:ncol(covariates)], use.names = FALSE))

carbon_test=as.numeric(unlist(covariates[22,2:ncol(covariates)], use.names = FALSE))
#how are NAs treated in qresplot?? #test revealed that it ignores them all good!


?qresplot
qres=qresplot(vcrpamr$PAC, carbon_test, xlab = "Age (years)", opacity = 0.5,
              main = "quasi residual plot for male passengers", plotLoess = TRUE)

#testing missing values
nona=which(!is.na(carbon_test))
vcrpamr$PAC[nona]

qres=qresplot(vcrpamr$PAC[400:800], carbon_test[400:800], xlab = "Age (years)", opacity = 0.5,
              main = "quasi residual plot for male passengers", plotLoess = TRUE)


#disturbance genes

coeff=rep(NA,ncol(t(data$x)))

for (i in 1:length(coeff)) {
  lm=lm(vcrpamr$PAC~t(data$x)[,i])
  coeff[i]=lm$coefficients[2]
}

sorted_indices <- order(coeff, decreasing = TRUE)
sorted_indices[1:10]
which.max(coeff)
lm(vcrpamr$PAC~t(khanc$x)[,424])

qres=qresplot(vcrpamr$PAC, t(data$x)[,], xlab = "Age (years)", opacity = 0.5,
              main = "quasi residual plot for male passengers", plotLoess = TRUE)
